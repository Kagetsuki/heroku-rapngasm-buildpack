#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

# Debug
# set -x

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="$BUILD_DIR/vendor"
EXPORT_PATH="$PWD/export"
PROFILE_PATH="$BUILD_DIR/.profile.d/rapngasm.sh"

mkdir -p $(dirname $PROFILE_PATH)

function setDefaultEnv (){
  echo "export $1=/app/vendor/$2:\$$1" >> $PROFILE_PATH
  echo "export $1=/app/vendor/$2:\$$1" >> $EXPORT_PATH
}

echo "=====> Inserting RAPNGAsm build system â˜¼"
cd $BUILD_DIR
echo "- Obtaining vendorized dependency pack"
wget "https://s3-ap-northeast-1.amazonaws.com/gensou/vendor.tar.bz2"
echo "- Unpacking"
tar -xjf "vendor.tar.bz2"
echo "- Removing tarball"
rm "vendor.tar.bz2"
echo "- Copying vendorized assets"
cp -ar "$VENDOR_DIR/bin" "/app/vendor/buildbin"
cp -ar "$VENDOR_DIR/include" "/app/vendor/include"
cp -ar "$VENDOR_DIR/lib" "/app/vendor/lib"
cp -ar "$VENDOR_DIR/share" "/app/vendor/share"

echo "- kludge package detection for gobject-introspection"
apt-get update
apt-get install -y "libgirepository1.0-dev"


# setDefaultEnv PATH "buildbin"
echo "export PATH=/app/vendor/buildbin:$PATH" >> $EXPORT_PATH
setDefaultEnv LIBRARY_PATH "lib"
setDefaultEnv LD_LIBRARY_PATH "lib"
setDefaultEnv CPATH "include"
setDefaultEnv XDG_DATA_DIRS "share"
echo "export XDG_DATA_DIRS=/app/vendor/share" >> $EXPORT_PATH
